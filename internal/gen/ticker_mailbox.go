package gen

import "strings"

type SimpleMailboxGenerator struct {
	ThisPackage  string
	MessageType  string
	MboxTypeBase string

	// actor generation only
	MboxTypeQual string
	ActorName    string
	FieldName    string
}

func (g *SimpleMailboxGenerator) GenerateGo(out *formatter) {
	out.executeTemplate(getTemplate(
		"simple_mailbox_go_file", `
// code generated by thespian; DO NOT EDIT

package {{.ThisPackage}}

// {{public .MboxTypeBase}}Mailbox is a mailbox for messages of type {{.MessageType}}.
type {{public .MboxTypeBase}}Mailbox struct {
	C chan {{.MessageType}}
}

func New{{public .MboxTypeBase}}Mailbox() {{public .MboxTypeBase}}Mailbox {
	return {{public .MboxTypeBase}}Mailbox{
		C: make(chan {{.MessageType}}, 10), // TODO: channel size??
	}
}

// Tx creates a {{.MboxTypeBase}}Tx for this mailbox
func (mbox *{{public .MboxTypeBase}}Mailbox) Tx() {{.MboxTypeBase}}Tx {
	return {{.MboxTypeBase}}Tx{
		C: mbox.C,
	}
}

// Rx creates a {{.MboxTypeBase}}Rx for this mailbox
func (mbox *{{public .MboxTypeBase}}Mailbox) Rx() {{.MboxTypeBase}}Rx {
	return {{.MboxTypeBase}}Rx{
		C: mbox.C,
	}
}

// {{.MboxTypeBase}}Tx sends to a mailbox for messages of type {{.MessageType}}.
type {{.MboxTypeBase}}Tx struct {
	C chan<- {{.MessageType}}
}

// {{.MboxTypeBase}}Rx receives from a mailbox for messages of type {{.MessageType}}.
type {{.MboxTypeBase}}Rx struct {
	C <-chan {{.MessageType}}
}`), g)
}

func (g *SimpleMailboxGenerator) ActorPublicStructDecl() string {
	return renderTemplate(
		"simple_actor_public_struct_decl",
		`{{.FieldName}}Tx {{.MboxTypeQual}}{{.MboxTypeBase}}Tx`,
		g)
}

func (g *SimpleMailboxGenerator) ActorPublicStructMethod() string {
	return renderTemplate(
		"simple_actor_public_struct_method", strings.TrimSpace(`
		// {{public .FieldName}} sends to the actor's {{.FieldName}} mailbox.
		func (a *{{public .ActorName}}) {{public .FieldName}}(m {{.MessageType}}) {
			a.{{private .FieldName}}Tx.C <- m
		}`), g)
}

func (g *SimpleMailboxGenerator) ActorSpawnSetupClause() string {
	return renderTemplate(
		"simple_actor_spawn_setup_clause",
		`{{.FieldName}}Mailbox := {{.MboxTypeQual}}New{{.MboxTypeBase}}Mailbox()`,
		g)
}

func (g *SimpleMailboxGenerator) ActorSpawnRxAssignmentClause() string {
	return renderTemplate(
		"simple_actor_spawn_rx_assignment_clause",
		`a.{{.FieldName}}Rx = {{.FieldName}}Mailbox.Rx()`,
		g)
}

func (g *SimpleMailboxGenerator) ActorSpawnHandleInitializer() string {
	return renderTemplate(
		"simple_actor_spawn_handle_initializer",
		`{{.FieldName}}Tx: {{.FieldName}}Mailbox.Tx(),`,
		g)
}

func (g *SimpleMailboxGenerator) ActorLoopCase() string {
	return renderTemplate(
		"simple_actor_spawn_loop_case", strings.TrimSpace(`
			case m := <-a.{{.FieldName}}Rx.C:
				a.handle{{public .FieldName}}(m)
		`), g)
}

func (g *SimpleMailboxGenerator) ActorCleanupClause() string {
	// TODO
	return ""
}
